<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Calories & Weight Calendar</title>
  <style>
    :root {
      --bg: #0b1220;
      --card: #121a2b;
      --muted: #93a4c7;
      --text: #e8eefc;
      --accent: #6ea8fe;
      --border: rgba(255, 255, 255, .08);
    }

    * {
      box-sizing: border-box
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: linear-gradient(180deg, #050815, var(--bg));
      color: var(--text)
    }

    header {
      display: flex;
      gap: 12px;
      align-items: center;
      justify-content: space-between;
      padding: 18px 18px 10px;
      position: sticky;
      top: 0;
      background: rgba(5, 8, 21, .85);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--border)
    }

    h1 {
      font-size: 18px;
      margin: 0
    }

    .wrap {
      max-width: 1150px;
      margin: 0 auto;
      padding: 16px
    }

    .grid {
      display: grid;
      grid-template-columns: 1.2fr .8fr;
      gap: 16px
    }

    @media (max-width: 980px) {
      .grid {
        grid-template-columns: 1fr
      }
    }

    .card {
      background: rgba(18, 26, 43, .92);
      border: 1px solid var(--border);
      border-radius: 16px;
      box-shadow: 0 12px 30px rgba(0, 0, 0, .35);
      overflow: hidden
    }

    .card h2 {
      font-size: 14px;
      margin: 0;
      padding: 12px 14px;
      border-bottom: 1px solid var(--border);
      color: #dfe8ff
    }

    .toolbar {
      display: flex;
      gap: 10px;
      align-items: center;
      padding: 10px 14px;
      border-bottom: 1px solid var(--border);
      flex-wrap: wrap
    }

    .toolbar button,
    .toolbar select {
      background: #0f1729;
      border: 1px solid var(--border);
      color: var(--text);
      border-radius: 10px;
      padding: 8px 10px
    }

    .toolbar button {
      cursor: pointer
    }

    .toolbar button:hover {
      border-color: rgba(255, 255, 255, .18)
    }

    .monthTitle {
      font-weight: 600
    }

    .cal {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
      padding: 12px
    }

    .dow {
      color: var(--muted);
      font-size: 12px;
      padding: 0 2px 8px
    }

    .day {
      min-height: 92px;
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 10px;
      background: rgba(15, 23, 41, .6);
      cursor: pointer;
      display: flex;
      flex-direction: column;
      gap: 6px
    }

    .day:hover {
      border-color: rgba(255, 255, 255, .18)
    }

    .day.out {
      opacity: .38
    }

    .day .top {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px
    }

    .badge {
      font-size: 11px;
      color: #0b1220;
      background: var(--accent);
      border-radius: 999px;
      padding: 2px 8px;
      font-weight: 700
    }

    .kv {
      font-size: 12px;
      color: #d9e4ff
    }

    .note {
      font-size: 12px;
      color: var(--muted);
      overflow: hidden;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical
    }

    .right {
      padding: 12px 14px
    }

    .stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px
    }

    .stat {
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 10px;
      background: rgba(15, 23, 41, .55)
    }

    .stat .k {
      color: var(--muted);
      font-size: 12px
    }

    .stat .v {
      font-size: 18px;
      font-weight: 700;
      margin-top: 2px
    }

    canvas {
      width: 100%;
      height: 280px
    }

    .small {
      color: var(--muted);
      font-size: 12px;
      margin-top: 10px;
      line-height: 1.4
    }

    /* modal */
    dialog {
      border: none;
      border-radius: 18px;
      max-width: 520px;
      width: calc(100% - 24px);
      background: rgba(18, 26, 43, .98);
      color: var(--text);
      box-shadow: 0 25px 70px rgba(0, 0, 0, .6)
    }

    dialog::backdrop {
      background: rgba(0, 0, 0, .6)
    }

    .modalHead {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 16px;
      border-bottom: 1px solid var(--border)
    }

    .modalHead strong {
      font-size: 14px
    }

    .modalBody {
      padding: 14px 16px;
      display: grid;
      gap: 10px
    }

    label {
      display: grid;
      gap: 6px;
      font-size: 12px;
      color: var(--muted)
    }

    input,
    textarea {
      background: #0f1729;
      border: 1px solid var(--border);
      border-radius: 12px;
      color: var(--text);
      padding: 10px 12px;
      font-size: 14px
    }

    textarea {
      min-height: 90px;
      resize: vertical
    }

    .modalFoot {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      padding: 12px 16px;
      border-top: 1px solid var(--border)
    }

    .btn {
      padding: 9px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: #0f1729;
      color: var(--text);
      cursor: pointer
    }

    .btn.primary {
      background: var(--accent);
      color: #0b1220;
      border-color: transparent;
      font-weight: 700
    }
  </style>
</head>

<body>
  <header>
    <h1>Calories & Weight Calendar</h1>
    <div class="toolbar">
      <button id="prev">â—€</button>
      <span class="monthTitle" id="title"></span>
      <button id="next">â–¶</button>
      <button id="today">Today</button>
      <button id="export">Export JSON</button>
      <button id="import">Import JSON</button>
    </div>
  </header>

  <div class="wrap">
    <div class="grid">
      <section class="card">
        <h2>Calendar (click any day to add calories / weight / notes)</h2>
        <div class="cal" id="cal"></div>
      </section>

      <aside class="card">
        <h2>Graphs & stats (from saved calendar data)</h2>
        <div class="right">
          <div class="stats">
            <div class="stat">
              <div class="k">Avg calories (visible month)</div>
              <div class="v" id="avgCal">â€”</div>
            </div>
            <div class="stat">
              <div class="k">Weight change (month)</div>
              <div class="v" id="wtChange">â€”</div>
            </div>
            <div class="stat">
              <div class="k">Days logged</div>
              <div class="v" id="daysLogged">â€”</div>
            </div>
            <div class="stat">
              <div class="k">Total calories</div>
              <div class="v" id="totalCal">â€”</div>
            </div>
          </div>

          <div style="margin-top:14px">
            <canvas id="calChart"></canvas>
          </div>
          <div style="margin-top:14px">
            <canvas id="wtChart"></canvas>
          </div>


          <div style="margin-top:16px;border-top:1px solid var(--border);padding-top:14px">
            <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap">
              <div style="font-weight:700;font-size:13px;color:#dfe8ff">Yearly view</div>
              <div style="display:flex;gap:8px;align-items:center">
                <span style="color:var(--muted);font-size:12px">Year</span>
                <select id="yearSel"
                  style="background:#0f1729;border:1px solid var(--border);color:var(--text);border-radius:10px;padding:8px 10px"></select>
              </div>
            </div>

            <div class="stats" style="margin-top:10px">
              <div class="stat">
                <div class="k">Total calories (year)</div>
                <div class="v" id="yearTotalCal">â€”</div>
              </div>
              <div class="stat">
                <div class="k">Avg calories/day (year)</div>
                <div class="v" id="yearAvgCalDay">â€”</div>
              </div>
            </div>

            <div style="margin-top:14px">
              <canvas id="yearCalChart"></canvas>
            </div>
            <div style="margin-top:14px">
              <canvas id="yearWtChart"></canvas>
            </div>

            <div class="small" style="margin-top:10px">
              Yearly calories chart shows monthly totals. Yearly weight chart shows monthly average weight (based on
              logged days).
            </div>
          </div>

          <div class="small">
            Data is stored in your browser (localStorage). Calories and weight are optional; notes are free text.
          </div>
        </div>
      </aside>
    </div>
  </div>

  <dialog id="dlg">
    <div class="modalHead">
      <strong id="dlgTitle">Edit</strong>
      <button class="btn" id="close">âœ•</button>
    </div>
    <div class="modalBody">
      <label>Calories (optional)
        <input id="inCal" inputmode="numeric" placeholder="e.g. 2100" />
      </label>
      <label>Weight (optional)
        <input id="inWt" inputmode="decimal" placeholder="e.g. 72.4" />
      </label>
      <label>Notes (optional)
        <textarea id="inNote" placeholder="free textâ€¦"></textarea>
      </label>
    </div>
    <div class="modalFoot">
      <button class="btn" id="delete">Delete</button>
      <button class="btn primary" id="save">Save</button>
    </div>
  </dialog>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script>
    const $ = (id) => document.getElementById(id);
    const STORE_KEY = "cw-calendar-v1";
    const DEFAULT_DATA_URL = "./data/calendar-data.json";

    // ðŸ” CHANGE THIS VALUE WHEN YOU UPDATE calendar-data.json
    const DEFAULT_DATA_VERSION = "2026-01-06";
    const DEFAULT_IMPORT_FLAG = `cw-default-imported-${DEFAULT_DATA_VERSION}`;

    /**
     * Merge strategy:
     * - keepExisting=true  => never overwrite existing dates (safest)
     * - keepExisting=false => overwrite existing dates with defaults
     */
    function mergeData(target, incoming, keepExisting = true) {
      const out = { ...target };
      for (const [k, v] of Object.entries(incoming || {})) {
        if (keepExisting && out[k]) continue;
        out[k] = v;
      }
      return out;
    }

    async function autoImportDefaultJsonOnce() {
      // Only run once per browser unless you reset the flag
      if (localStorage.getItem(DEFAULT_IMPORT_FLAG) === "1") return;

      try {
        const res = await fetch(DEFAULT_DATA_URL, { cache: "no-store" });
        if (!res.ok) return; // if file missing, do nothing
        const incoming = await res.json();
        if (!incoming || typeof incoming !== "object") return;

        const current = loadAll();
        const merged = mergeData(current, incoming, true); // true = don't overwrite user data
        saveAll(merged);

        localStorage.setItem(DEFAULT_IMPORT_FLAG, "1");
      } catch (e) {
        // If GitHub Pages canâ€™t fetch (rare), fail silently
      }
    }

    function loadAll() {
      try { return JSON.parse(localStorage.getItem(STORE_KEY) || "{}"); }
      catch { return {}; }
    }
    function saveAll(obj) {
      localStorage.setItem(STORE_KEY, JSON.stringify(obj));
    }
    function ymd(d) {
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      return `${d.getFullYear()}-${m}-${day}`;
    }
    function parseNum(v) {
      if (v === null || v === undefined) return null;
      const s = String(v).trim().replace(",", ".");
      if (!s) return null;
      const n = Number(s);
      return Number.isFinite(n) ? n : null;
    }

    let view = new Date();
    view.setDate(1);

    const DOW = ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"];

    let calChart, wtChart;
    let yearCalChart, yearWtChart;
    let selectedYear = (new Date()).getFullYear();

    function allYearsAvailable() {
      const all = loadAll();
      const years = new Set();
      for (const k of Object.keys(all)) {
        const m = /^\d{4}-\d{2}-\d{2}$/.exec(k);
        if (!m) continue;
        years.add(Number(k.slice(0, 4)));
      }
      if (years.size === 0) years.add((new Date()).getFullYear());
      return Array.from(years).sort((a, b) => a - b);
    }

    function fillYearSelector() {
      const sel = $("yearSel");
      if (!sel) return;
      const years = allYearsAvailable();
      sel.innerHTML = "";
      for (const y of years) {
        const opt = document.createElement("option");
        opt.value = String(y);
        opt.textContent = String(y);
        sel.appendChild(opt);
      }
      // keep selectedYear if possible
      if (!years.includes(selectedYear)) selectedYear = years[years.length - 1];
      sel.value = String(selectedYear);
      sel.onchange = () => {
        selectedYear = Number(sel.value);
        updateYearlyCharts();
      };
    }

    function dataForYear(year) {
      const all = loadAll();
      const items = [];
      for (const [key, val] of Object.entries(all)) {
        if (!/^\d{4}-\d{2}-\d{2}$/.test(key)) continue;
        const y = Number(key.slice(0, 4));
        if (y !== year) continue;
        const mm = Number(key.slice(5, 7)); // 1..12
        const dd = Number(key.slice(8, 10));
        items.push({ key, y, mm, dd, ...val });
      }
      items.sort((a, b) => a.key.localeCompare(b.key));
      return items;
    }

    function aggregateYearByMonth(year) {
      const items = dataForYear(year);
      const months = Array.from({ length: 12 }, (_, i) => i + 1);
      const calTotals = months.map(() => 0);
      const calDays = months.map(() => 0);
      const wtSum = months.map(() => 0);
      const wtDays = months.map(() => 0);

      for (const it of items) {
        const idx = it.mm - 1;
        if (it.cal != null) {
          calTotals[idx] += Number(it.cal) || 0;
          calDays[idx] += 1;
        }
        if (it.wt != null) {
          wtSum[idx] += Number(it.wt) || 0;
          wtDays[idx] += 1;
        }
      }

      const wtAvg = months.map((m, i) => wtDays[i] ? (wtSum[i] / wtDays[i]) : null);
      const calTotalYear = calTotals.reduce((a, b) => a + b, 0);
      const daysWithAnyEntry = new Set(items.map(x => x.key)).size;
      const avgCalPerDay = (daysWithAnyEntry && calTotalYear) ? (calTotalYear / daysWithAnyEntry) : null;

      return { months, calTotals, wtAvg, calTotalYear, avgCalPerDay };
    }

    function updateYearlyCharts() {
      const sel = $("yearSel");
      if (sel) {
        // refresh options in case new years were added
        const prev = selectedYear;
        fillYearSelector();
        selectedYear = prev;
        sel.value = String(selectedYear);
      }
      const agg = aggregateYearByMonth(selectedYear);
      const labels = agg.months.map(m => new Date(selectedYear, m - 1, 1).toLocaleString(undefined, { month: "short" }));

      $("yearTotalCal").textContent = agg.calTotalYear ? String(Math.round(agg.calTotalYear)) : "â€”";
      $("yearAvgCalDay").textContent = agg.avgCalPerDay != null ? String(Math.round(agg.avgCalPerDay)) : "â€”";

      if (yearCalChart) yearCalChart.destroy();
      if (yearWtChart) yearWtChart.destroy();

      yearCalChart = new Chart($("yearCalChart"), {
        type: "bar",
        data: { labels, datasets: [{ label: `Calories (monthly total)`, data: agg.calTotals }] },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: true } }, scales: { y: { beginAtZero: true } } }
      });

      yearWtChart = new Chart($("yearWtChart"), {
        type: "line",
        data: { labels, datasets: [{ label: `Weight (monthly avg)`, data: agg.wtAvg, spanGaps: true }] },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: true } }, scales: { y: { beginAtZero: false } } }
      });
    }


    function monthRange(d) {
      const y = d.getFullYear(), m = d.getMonth();
      const first = new Date(y, m, 1);
      const last = new Date(y, m + 1, 0);
      return { first, last };
    }

    function buildCalendar() {
      const all = loadAll();
      const { first, last } = monthRange(view);

      $("title").textContent = first.toLocaleString(undefined, { month: "long", year: "numeric" });

      const cal = $("cal");
      cal.innerHTML = "";
      // DOW headers
      for (const dn of DOW) {
        const el = document.createElement("div");
        el.className = "dow";
        el.textContent = dn;
        cal.appendChild(el);
      }
      // Find Monday-based start for grid
      const start = new Date(first);
      const wd = (start.getDay() + 6) % 7; // Mon=0..Sun=6
      start.setDate(start.getDate() - wd);

      // 6 weeks grid
      for (let i = 0; i < 42; i++) {
        const d = new Date(start);
        d.setDate(start.getDate() + i);
        const key = ymd(d);
        const item = all[key] || {};
        const out = d.getMonth() !== first.getMonth();

        const cell = document.createElement("div");
        cell.className = "day" + (out ? " out" : "");
        cell.dataset.key = key;

        const top = document.createElement("div");
        top.className = "top";

        const num = document.createElement("div");
        num.textContent = d.getDate();

        const badge = document.createElement("div");
        badge.className = "badge";
        const logged = (item.cal != null) || (item.wt != null) || (item.note && item.note.trim());
        badge.textContent = logged ? "âœ“" : "";
        badge.style.visibility = logged ? "visible" : "hidden";

        top.appendChild(num);
        top.appendChild(badge);

        const kv = document.createElement("div");
        kv.className = "kv";
        const parts = [];
        if (item.cal != null) parts.push(`Cal: ${item.cal}`);
        if (item.wt != null) parts.push(`Wt: ${item.wt}`);
        kv.textContent = parts.join(" â€¢ ") || "â€”";

        const note = document.createElement("div");
        note.className = "note";
        note.textContent = item.note || "";

        cell.appendChild(top);
        cell.appendChild(kv);
        cell.appendChild(note);

        cell.addEventListener("click", () => openEditor(key, d));
        cal.appendChild(cell);
      }

      updateStatsAndCharts();
    }

    let activeKey = null;

    function openEditor(key, d) {
      activeKey = key;
      const all = loadAll();
      const item = all[key] || {};
      $("dlgTitle").textContent = d.toLocaleDateString(undefined, { weekday: "long", year: "numeric", month: "short", day: "numeric" });
      $("inCal").value = item.cal ?? "";
      $("inWt").value = item.wt ?? "";
      $("inNote").value = item.note ?? "";
      $("dlg").showModal();
    }

    function closeEditor() {
      $("dlg").close();
      activeKey = null;
    }

    $("close").addEventListener("click", closeEditor);

    $("save").addEventListener("click", () => {
      if (!activeKey) return;
      const all = loadAll();
      const cal = parseNum($("inCal").value);
      const wt = parseNum($("inWt").value);
      const note = $("inNote").value || "";
      const hasAny = (cal != null) || (wt != null) || (note.trim().length > 0);
      if (hasAny) {
        all[activeKey] = { cal, wt, note };
      } else {
        delete all[activeKey];
      }
      saveAll(all);
      closeEditor();
      buildCalendar();
    });

    $("delete").addEventListener("click", () => {
      if (!activeKey) return;
      const all = loadAll();
      delete all[activeKey];
      saveAll(all);
      closeEditor();
      buildCalendar();
    });

    $("prev").addEventListener("click", () => { view.setMonth(view.getMonth() - 1); buildCalendar(); });
    $("next").addEventListener("click", () => { view.setMonth(view.getMonth() + 1); buildCalendar(); });
    $("today").addEventListener("click", () => { const t = new Date(); view = new Date(t.getFullYear(), t.getMonth(), 1); buildCalendar(); });

    function dataForVisibleMonth() {
      const all = loadAll();
      const { first, last } = monthRange(view);
      const items = [];
      for (let d = new Date(first); d <= last; d.setDate(d.getDate() + 1)) {
        const key = ymd(d);
        const it = all[key];
        if (it) items.push({ date: new Date(d), key, ...it });
      }
      items.sort((a, b) => a.date - b.date);
      return items;
    }

    function updateStatsAndCharts() {
      const items = dataForVisibleMonth();
      const calVals = items.filter(x => x.cal != null);
      const wtVals = items.filter(x => x.wt != null);

      const daysLogged = items.length;
      $("daysLogged").textContent = daysLogged ? String(daysLogged) : "â€”";

      const totalCal = calVals.reduce((s, x) => s + (x.cal || 0), 0);
      $("totalCal").textContent = calVals.length ? String(Math.round(totalCal)) : "â€”";

      const avg = calVals.length ? (totalCal / calVals.length) : null;
      $("avgCal").textContent = avg != null ? String(Math.round(avg)) : "â€”";

      if (wtVals.length >= 2) {
        const delta = wtVals[wtVals.length - 1].wt - wtVals[0].wt;
        const sign = delta > 0 ? "+" : "";
        $("wtChange").textContent = sign + delta.toFixed(1);
      } else {
        $("wtChange").textContent = "â€”";
      }

      // charts
      const labels = items.map(x => x.key.slice(8)); // day
      const cdata = items.map(x => x.cal ?? null);
      const wdata = items.map(x => x.wt ?? null);

      if (calChart) calChart.destroy();
      if (wtChart) wtChart.destroy();

      calChart = new Chart($("calChart"), {
        type: "line",
        data: { labels, datasets: [{ label: "Calories", data: cdata, spanGaps: true }] },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: true } }, scales: { y: { beginAtZero: false } } }
      });
      wtChart = new Chart($("wtChart"), {
        type: "line",
        data: { labels, datasets: [{ label: "Weight", data: wdata, spanGaps: true }] },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: true } }, scales: { y: { beginAtZero: false } } }
      });

      // yearly charts
      fillYearSelector();
      updateYearlyCharts();
    }

    function download(filename, text) {
      const a = document.createElement("a");
      a.href = URL.createObjectURL(new Blob([text], { type: "application/json" }));
      a.download = filename;
      a.click();
      URL.revokeObjectURL(a.href);
    }

    $("export").addEventListener("click", () => {
      const all = loadAll();
      download("calendar-data.json", JSON.stringify(all, null, 2));
    });

    $("import").addEventListener("click", async () => {
      const inp = document.createElement("input");
      inp.type = "file";
      inp.accept = "application/json";
      inp.onchange = async () => {
        const file = inp.files[0];
        if (!file) return;
        const txt = await file.text();
        try {
          const obj = JSON.parse(txt);
          if (obj && typeof obj === "object") {
            saveAll(obj);
            buildCalendar();
          }
        } catch (e) { alert("Invalid JSON file."); }
      };
      inp.click();
    });

    (async () => {
      await autoImportDefaultJsonOnce();
      buildCalendar();
    })();

  </script>
</body>

</html>